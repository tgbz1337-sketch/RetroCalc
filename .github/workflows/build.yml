name: Build APK

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Build with Gradle
        run: |
          cd app
          cat > build.gradle.kts << 'EOF'
          plugins {
              id("com.android.application") version "8.2.2"
              id("org.jetbrains.kotlin.android") version "1.9.22"
          }
          
          android {
              namespace = "com.retrocalc.app"
              compileSdk = 34
              
              defaultConfig {
                  applicationId = "com.retrocalc.app"
                  minSdk = 26
                  targetSdk = 34
                  versionCode = 1
                  versionName = "1.0"
              }
              
              buildFeatures {
                  compose = true
              }
              
              composeOptions {
                  kotlinCompilerExtensionVersion = "1.5.10"
              }
              
              kotlinOptions {
                  jvmTarget = "17"
              }
          }
          
          repositories {
              google()
              mavenCentral()
          }
          
          dependencies {
              implementation("androidx.activity:activity-compose:1.8.2")
              implementation("androidx.compose.material3:material3:1.2.0")
              implementation("androidx.compose.ui:ui:1.6.2")
          }
          EOF
          
          cd ..
          cat > build.gradle.kts << 'EOF'
          plugins {
              id("com.android.application") version "8.2.2" apply false
              id("org.jetbrains.kotlin.android") version "1.9.22" apply false
          }
          EOF
          
          cat > settings.gradle.kts << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          
          dependencyResolutionManagement {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          
          rootProject.name = "RetroCalc"
          include(":app")
          EOF
          
          gradle wrapper
          ./gradlew assembleRelease
      
      - uses: actions/upload-artifact@v4
        with:
          name: RetroCalc-APK
          path: app/build/outputs/apk/release/*.apk
